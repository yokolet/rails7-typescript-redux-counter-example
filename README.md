# Rails 7 TypeScript Redux Toolkit Counter Example

This example shows how to create a React-Redux application on Rails 7 using esbuild.

Versions
- Ruby: 3.2.2
- Rails: 7.0.3.4

### Rails 7 and esbuild

Rails 7 has the `-j | --javascript` option to choose the way to build JavaScript application.
The choices are importmap (default), webpack, esbuild adn rollup.
Since the webpack has been retired, the popular choice would be importmap or esbuild.
The application here chose [esbuild](https://esbuild.github.io/), which is commonly used in JavaScript world.
The esbuild itself is written in Go-lang and known to run fast.
It bundles JavaScript, TypeScript, CSS and JSX (TSX).


### Create a Rails app with esbuild option

Below creates the Rails app with esbuild option:

```bash
% rails new [APP NAME] -j esbuild -T
% cd [APP NAME]
```

The generated code includes package.json and tools to create a ReactJS app.

The next step is to create an entry point for the ReactJS app.

```bash
% rails g stimulus react
```

Above generates `app/javascript/controllers/react_controller.rb`.
The controller is equivalent to index.ts(js) for a React application.
In the `connect` method, we can write exactly the same code as React app's index.ts(js).


The following step is to create a Rails controller for a route to home page.
This is nothing special, a common Rails controller generation.

```bash
% rails g cotroller pages home
```

Then, edit `app/views/pages/home.html.erb`  and `config/routes.rb` to
make a path to the entry point.


```erbruby
<h1>Pages#home</h1>
<p>Find me in app/views/pages/home.html.erb</p>
<%= content_tag(:div, "", id:"app", data:{ controller: "react" }) %>
```

```ruby
Rails.application.routes.draw do
  root 'pages#home'
end
```

That's all for a Rails side setup.

### Create a ReactJS application

At this stage, the application is like just after `yarn --init` gets run.
The `package.json` is there, but only basic JavaScript packages are installed.
At least, ReactJS related packages should be installed prior to write some
ReactJS code.

```bash
% yarn add react react-dom @types/react @types/react-dom typescript
% tsc --init --project tsconfig.json --noEmit --jsx react-jsx
```

For a speedy sample development, the react-redux counter application was copied from what
`yarn create-react-app my-app --template redux-typescript` command created.


### package.json update

As we know, TypeScript files should be transpiled to JavaScript.
The setting should be done in package.json's scripts section.

The counter app has a Redux logo image referenced in App.tsx.
The image loader setup for esbuild is necessary.
Also, the jsx loader should be set up.

Edit the scripts section in the `package.json`.

```json
{
  ...
  "scripts": {
    "build": "esbuild app/javascript/*.* --bundle --sourcemap --outdir=app/assets/builds --public-path=assets --loader:.js=jsx --loader:.svg=file",
    "check-types": "tsc --project tsconfig.json --noEmit --watch --preserveWatchOutput"
  },
  ...
}
```

### Avoid Sprockets::DoubleLinkError application.css

When a .tsx(.jsx) file imports CSS, esbuild generates `app/assets/builds/application.css`.
Whereas we have `app/assets/stylesheets/application.css` generated by rails new command.
These two application.css files cause Sprockets::DoubleLinkError.
The options of esbuild don't work unfortunately since multiple .tsx and .ts files are there.
To bundle all those, esbuild needs the --outdir option, which means --outfile option is unable to use.

We can avoid the issue by at least below two approaches.

1. Never ever import css in .tsx files. Instead, write all styles in `app/assets/stylesheets/application.css`.
2. Rename `app/assets/stylesheets/application.css`.

The app here uses the second approach.
The file name is renamed to application-rails.css.
One more stylesheet_link_tag was added to `app/views/layouts/application.html.erb`.

### Use bin/dev, Not rails s

As defined in `Procfile.dev`, we need to startup two servers.
The command for that is `bin/dev`.
